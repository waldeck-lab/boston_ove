# obsevatory install

#!/usr/bin/env sh
set -e

. "$OVE_OWEL_DIR/scripts/stage_lib.sh"
debug_on

require_env_dir OVE_BASE_DIR

SRC_DB="$OVE_BASE_DIR/stage/tmp/.obs-db-tmp/sos_counts.sqlite"
DST_DIR="$OVE_BASE_DIR/stage/db"
DST_DB="$DST_DIR/sos_counts.sqlite"

say "Observatory install: src_db=$SRC_DB"
say "Observatory install: dst_db=$DST_DB"

require_file_nonempty "$SRC_DB" "SOS sqlite source DB"
ensure_dir "$DST_DIR"

# Atomic-ish publish: copy to temp and then rename into place
TMP_DB="$DST_DIR/.sos_counts.sqlite.new.$$"
run "Copy DB to staging" cp "$SRC_DB" "$TMP_DB"
run "Publish DB" mv "$TMP_DB" "$DST_DB"

say "Observatory install OK: $DST_DB"
