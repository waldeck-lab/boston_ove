#!/usr/bin/env sh
set -e

. "$OVE_OWEL_DIR/scripts/stage_lib.sh"
debug_on

require_env_dir OVE_BASE_DIR

SCRIPT="$OVE_BASE_DIR/boston_sos_observatory/scripts/counts.py"
SOS_DB="$OVE_BASE_DIR/stage/db/sos_counts.sqlite"
OUT_DIR_TMP="$OVE_BASE_DIR/stage/tmp/.counts-tmp"
OUT_CSV="$OUT_DIR_TMP/taxa_counts.csv"

say "Counts build: script=$SCRIPT"
say "Counts build: db=$SOS_DB"
say "Counts build: out=$OUT_CSV"

require_file_nonempty "$SOS_DB" "SOS DB"
ensure_dir "$OUT_DIR_TMP"
clean_glob "$OUT_DIR_TMP" "*.csv"

python_run "$SCRIPT" --db "$SOS_DB" --out "$OUT_CSV"
require_file_nonempty "$OUT_CSV" "counts output CSV"

say "Counts build OK: $OUT_CSV"
