# crossmatch build

#!/usr/bin/env sh
set -e

. "$OVE_OWEL_DIR/scripts/stage_lib.sh"
debug_on

require_env_dir OVE_BASE_DIR

SCRIPT="$OVE_BASE_DIR/boston_sos_observatory/scripts/crossmatch_lepidoptera.py"
DYNTAXA_DB="$OVE_BASE_DIR/stage/db/dyntaxa_lepidoptera.sqlite"
SOS_DB="$OVE_BASE_DIR/stage/db/sos_counts.sqlite"
OUT_DIR_TMP="$OVE_BASE_DIR/stage/tmp/.lists-tmp"

say "Crossmatch build: script=$SCRIPT"
say "Crossmatch build: dyntaxa_db=$DYNTAXA_DB"
say "Crossmatch build: sos_db=$SOS_DB"
say "Crossmatch build: out_dir=$OUT_DIR_TMP"

require_file_readable "$SCRIPT" "Crossmatch script"
require_file_nonempty "$DYNTAXA_DB" "Dyntaxa DB"
require_file_nonempty "$SOS_DB" "SOS DB"

ensure_dir "$OUT_DIR_TMP"
clean_glob "$OUT_DIR_TMP" "*.csv"

python_run "$SCRIPT" \
  --dyntaxa-db "$DYNTAXA_DB" \
  --sos-db "$SOS_DB" \
  --out-dir "$OUT_DIR_TMP"

# Validate that the script actually produced CSVs
require_at_least_one_file "$OUT_DIR_TMP" "*.csv" "crossmatch CSV outputs"
require_no_empty_files "$OUT_DIR_TMP" "*.csv" "crossmatch CSV outputs"

say "Crossmatch build OK: produced $(count_files "$OUT_DIR_TMP" "*.csv") CSV file(s) in $OUT_DIR_TMP"
