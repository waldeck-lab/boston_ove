#!/usr/bin/env sh
set -e

fail() { echo "ERROR: $*" >&2; exit 1; }

# Verify OVE_BASE_DIR
[ -n "${OVE_BASE_DIR:-}" ] || fail "OVE_BASE_DIR is not set."
[ -d "$OVE_BASE_DIR" ] || fail "OVE_BASE_DIR is not a directory: $OVE_BASE_DIR"

# crossmatch outputs here
OUT_DIR_TMP="$OVE_BASE_DIR/stage/tmp/.lists-tmp"
SRC_DIR="$OUT_DIR_TMP"
DST_DIR="$OVE_BASE_DIR/stage/lists"

# Check src/dst exist
[ -d "$SRC_DIR" ] || fail "Source tmp dir not found: $SRC_DIR"
mkdir -p "$DST_DIR" || fail "Could not create destination dir: $DST_DIR"

# Ensure there is at least one CSV to publish
# (POSIX-safe: use find, not nullglob)
CSV_COUNT="$(find "$SRC_DIR" -maxdepth 1 -type f -name '*.csv' 2>/dev/null | wc -l | tr -d ' ')"
[ "$CSV_COUNT" -gt 0 ] || fail "No CSV files found to publish in: $SRC_DIR"

# Optional: sanity check non-empty CSVs
EMPTY_COUNT="$(find "$SRC_DIR" -maxdepth 1 -type f -name '*.csv' -size 0 2>/dev/null | wc -l | tr -d ' ')"
[ "$EMPTY_COUNT" -eq 0 ] || fail "One or more CSV files are empty in: $SRC_DIR"

# Publish atomically-ish:
# Copy to a temp dir under the destination, then move into place.
PUBLISH_TMP="$DST_DIR/.publish.$$"
mkdir -p "$PUBLISH_TMP" || fail "Could not create publish temp dir: $PUBLISH_TMP"

# Copy csv files
# Use find+xargs to avoid glob/space issues
find "$SRC_DIR" -maxdepth 1 -type f -name '*.csv' -print0 \
  | xargs -0 -I {} cp "{}" "$PUBLISH_TMP/"

# If copy succeeded, replace destination contents (only CSVs) safely:
# 1) remove old CSVs
# 2) move new CSVs in
rm -f "$DST_DIR"/*.csv 2>/dev/null || true
mv "$PUBLISH_TMP"/*.csv "$DST_DIR/" || fail "Failed to move published CSVs into: $DST_DIR"

# Cleanup temp dir
rmdir "$PUBLISH_TMP" 2>/dev/null || true

echo "Published $CSV_COUNT CSV file(s) from $SRC_DIR -> $DST_DIR"
     #!/usr/bin/env sh
